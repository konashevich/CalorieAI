# CalorieAI Android – Single Source of Truth (in progress)

This document records the final design decisions and the stubborn issues we hit (and solved). It replaces all interim notes. Keep this up to date.

## What we ship now (current design)
- Platform: Cordova Android app (no web/PWA fallback in the APK build).
- Recording flow: In‑app recording on the "Recorded" page using a native recorder plugin. User stays in the app; first tap requests microphone permission, then records up to 60 minutes.
- Audio format: AAC (.m4a), which Gemini supports (MIME: audio/aac). No conversion pipeline.
- Send to AI: Upload the recorded AAC to Gemini. If the combined request could exceed ~20 MB, use the Gemini Files API; otherwise direct attach is OK.

## The hard problems and how they were fixed
1. Mic permission never prompted
   - Root causes encountered:
     - Using web APIs (getUserMedia) in a Cordova APK; this often fails on many devices and won’t invoke the Cordova permission flow.
     - Running permission checks before `deviceready` or without `cordova.js` on device builds.
     - CI copying web assets over Cordova `www`, accidentally dropping `cordova.js` and plugin bootstrapping.
   - Final fix:
     - Use native Cordova permission plugin and explicitly request `RECORD_AUDIO` on the first Mic tap.
     - Ensure `cordova.js` is present in the packaged app (don’t overwrite Cordova `www` from the `web/` folder in CI).
     - Handle all outcomes: granted, denied (show rationale + retry), and “don’t ask again” (deep link to system settings).

2. CI/Build instability
   - Symptom: GitHub Actions failed with `npm ci` because there was no `package-lock.json` in the app folder.
   - Resolution:
     - Either check in `package-lock.json` under `calorieai-android/` or switch CI to `npm install` in that directory.

3. Local plugin not found in CI
   - Symptom: `Failed to fetch plugin ... file:plugins/cordova-plugin-aac-recorder` because CI tried to pull from the generated `plugins/` tree.
   - Resolution:
     - Keep the plugin source under `calorieai-android/local-plugins/cordova-plugin-aac-recorder` in the repo and reference that path (not the generated `plugins/` folder). The generated `plugins/` folder is build state and should not be used as a source.

4. External/native recorder handoff caused UX drift
   - Earlier attempts opened a system recorder app; it broke theming and control and confused users.
   - Final choice: in‑app native plugin recorder so user never leaves the page. All “native app” handoff code and web fallbacks were removed.

## Best practices (finalized)
- Cordova-only in APK: Do not use web media APIs in the Android build. Keep all audio recording via the native plugin.
- Ask permission on first intent to record; never at app start. Show clear rationale if denied; deep link to Settings if permanently denied.
- Don’t touch `www/` from `web/` in CI. The APK must include `cordova.js` and plugin bootstrap generated by Cordova.
- Keep local plugins under `calorieai-android/local-plugins/...` and reference those paths in `config.xml` or the build step. Never reference the generated `plugins/` folder.
- AAC is the default output. If a file might exceed 20 MB, upload with Gemini Files API; otherwise send inline.
- Gate recording length to 60 minutes; stop cleanly on app background/terminate.
- All recording actions should run after `deviceready` only.

## CI shape (summary)
- Working directory: `calorieai-android/`.
- Install: `npm install` (or `npm ci` only if `package-lock.json` is committed in that folder).
- Platform: `cordova platform add android@14` (idempotent in CI).
- Plugins: add standard plugins plus the local AAC recorder via its repo path under `local-plugins/`.
- Guard: Do not sync `web/` into Cordova `www/` during CI.
- Build: `cordova build android --release` (and sign if configured).

## Testing checklist (quick)
- Fresh install: first Mic tap prompts for permission, then records.
- Deny once: rationale shown; user can retry request.
- “Don’t ask again”: prompt displays Settings guidance and deep link.
- Uninstall/reinstall: Android resets runtime permissions; prompt should appear again on first Mic tap.
- Long record: can run to 60 minutes; file saved and upload pathway works.
- Large file: verify Files API path on >20 MB.

## Known limits / next
- Long-session battery/network handling (warn on low battery; pause/resume if needed).
- User storage management (list/delete old recordings).
- Retain and surface upload status/errors with retry.

## Operational notes
- If permission prompt stops appearing, verify:
  - `cordova.js` is present in the packaged `www` and `deviceready` fires before any recorder call.
  - CI didn’t replace Cordova `www` with `web/`.
  - The recorder and permission plugins are installed at build time and initialized on app start.
- If CI can’t find the AAC plugin, confirm its path under `local-plugins/` and that it’s added by path, not by the generated `plugins/` folder.

— End of single-source notes —